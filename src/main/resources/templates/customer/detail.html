<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: page('Detalhe do Cliente', ~{::main-content})}">
<div th:fragment="main-content">

    <div class="breadcrumb">
        <a href="/">Inicio</a> <span>/</span> <a href="/customers">Clientes</a> <span>/</span> <span th:text="${customer.name()}">Cliente</span>
    </div>

    <div class="page-header">
        <h1 th:text="${customer.name()}">Nome do Cliente</h1>
        <div class="btn-group">
            <a th:href="@{/cart/{id}(id=${customer.id()})}" class="btn btn-accent">Carrinho</a>
            <a th:href="@{/orders/customer/{id}(id=${customer.id()})}" class="btn btn-primary">Pedidos</a>
            <a th:href="@{/coupons/customer/{id}(id=${customer.id()})}" class="btn btn-outline">Cupons</a>
            <span th:if="${customer.isActive()}" class="badge badge-active">Ativo</span>
            <span th:unless="${customer.isActive()}" class="badge badge-inactive">Inativo</span>
        </div>
    </div>

    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

    <div class="detail-grid">
        <div class="card">
            <div class="card-header">Informacoes Gerais</div>
            <div class="form-row">
                <div class="info-group">
                    <div class="info-label">Codigo do Cliente</div>
                    <div class="info-value" th:text="${customer.customerCode()}"></div>
                </div>
                <div class="info-group">
                    <div class="info-label">Ranking</div>
                    <div class="info-value" th:text="${customer.ranking()}"></div>
                </div>
            </div>
            <div class="form-row">
                <div class="info-group">
                    <div class="info-label">CPF</div>
                    <div class="info-value" th:text="${customer.cpf()}"></div>
                </div>
                <div class="info-group">
                    <div class="info-label">E-mail</div>
                    <div class="info-value" th:text="${customer.email()}"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Atualizar Dados</div>
        <form method="post" th:action="@{/customers/{id}/update(id=${customer.id()})}">
            <div class="form-row">
                <div class="form-group">
                    <label>Genero</label>
                    <select name="gender">
                        <option th:each="g : ${genders}" th:value="${g}" th:text="${g}" th:selected="${customer.gender() == g}"></option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nome Completo *</label>
                    <input type="text" name="name" th:value="${customer.name()}" required/>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Data de Nascimento *</label>
                    <input type="date" name="dateOfBirth" th:value="${customer.dateOfBirth()}" required/>
                </div>
                <div class="form-group">
                    <label>E-mail *</label>
                    <input type="email" name="email" th:value="${customer.email()}" required/>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Salvar Alteracoes</button>
        </form>
    </div>

    <div class="detail-grid">
        <div class="card">
            <div class="card-header">Alterar Senha</div>
            <form method="post" th:action="@{/customers/{id}/change-password(id=${customer.id()})}" id="changePasswordForm">
                <div class="form-group">
                    <label>Nova Senha *</label>
                    <input type="password" name="newPassword" required minlength="8" id="newPw"/>
                    <div class="form-hint">Minimo 8 caracteres, letras maiusculas, minusculas e caracteres especiais.</div>
                </div>
                <div class="form-group">
                    <label>Confirmar Nova Senha *</label>
                    <input type="password" name="confirmPassword" required minlength="8" id="confirmNewPw"/>
                </div>
                <button type="submit" class="btn btn-warning">Alterar Senha</button>
            </form>
            <script>
                document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
                    var pw = document.getElementById('newPw').value;
                    var cpw = document.getElementById('confirmNewPw').value;
                    if (pw !== cpw) { e.preventDefault(); alert('As senhas nao coincidem.'); return false; }
                    if (pw.length < 8) { e.preventDefault(); alert('A senha deve ter no minimo 8 caracteres.'); return false; }
                    if (!/[A-Z]/.test(pw)) { e.preventDefault(); alert('A senha deve conter pelo menos uma letra maiuscula.'); return false; }
                    if (!/[a-z]/.test(pw)) { e.preventDefault(); alert('A senha deve conter pelo menos uma letra minuscula.'); return false; }
                    if (!/[^a-zA-Z0-9]/.test(pw)) { e.preventDefault(); alert('A senha deve conter pelo menos um caractere especial.'); return false; }
                });
            </script>
        </div>

        <div class="card" th:if="${customer.isActive()}">
            <div class="card-header">Inativar Cliente</div>
            <p style="margin-bottom:1rem;color:var(--color-text-muted);">Ao inativar, o cliente nao podera mais realizar compras.</p>
            <form method="post" th:action="@{/customers/{id}/deactivate(id=${customer.id()})}">
                <button type="submit" class="btn btn-danger">Inativar Cliente</button>
            </form>
        </div>
    </div>

    <hr class="section-divider"/>

    <div class="card">
        <div class="card-header">Telefones</div>
        <div th:if="${customer.phones() != null and !customer.phones().isEmpty()}">
            <table>
                <thead><tr><th>Tipo</th><th>DDD</th><th>Numero</th></tr></thead>
                <tbody>
                    <tr th:each="phone : ${customer.phones()}">
                        <td th:text="${phone.type()}"></td>
                        <td th:text="${phone.areaCode()}"></td>
                        <td th:text="${phone.number()}"></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div th:if="${customer.phones() == null or customer.phones().isEmpty()}" class="empty-state">
            <p>Nenhum telefone cadastrado.</p>
        </div>
        <div class="form-section" style="margin-top:1rem;">
            <div class="form-section-title">Adicionar Telefone</div>
            <form method="post" th:action="@{/customers/{id}/phones(id=${customer.id()})}">
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo *</label>
                        <select name="type" required>
                            <option value="">Selecione...</option>
                            <option th:each="t : ${phoneTypes}" th:value="${t}" th:text="${t}"></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>DDD *</label>
                        <input type="text" name="areaCode" required placeholder="11" maxlength="3"/>
                    </div>
                    <div class="form-group">
                        <label>Numero *</label>
                        <input type="text" name="phoneNumber" required placeholder="99999-9999"/>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Adicionar Telefone</button>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Enderecos</div>
        <div th:if="${customer.addresses() != null and !customer.addresses().isEmpty()}">
            <table>
                <thead><tr><th>Finalidade</th><th>Identificacao</th><th>Logradouro</th><th>Numero</th><th>Cidade</th><th>Estado</th><th>Status</th></tr></thead>
                <tbody>
                    <tr th:each="addr : ${customer.addresses()}">
                        <td th:text="${addr.purpose()}"></td>
                        <td th:text="${addr.label()}"></td>
                        <td th:text="${addr.street()}"></td>
                        <td th:text="${addr.number()}"></td>
                        <td th:text="${addr.city()}"></td>
                        <td th:text="${addr.state()}"></td>
                        <td>
                            <span th:if="${addr.isActive()}" class="badge badge-active">Ativo</span>
                            <span th:unless="${addr.isActive()}" class="badge badge-inactive">Inativo</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div th:if="${customer.addresses() == null or customer.addresses().isEmpty()}" class="empty-state">
            <p>Nenhum endereco cadastrado. E obrigatorio pelo menos um endereco de cobranca e um de entrega.</p>
        </div>
        <div class="form-section" style="margin-top:1rem;">
            <div class="form-section-title">Adicionar Endereco</div>
            <form method="post" th:action="@{/customers/{id}/addresses(id=${customer.id()})}">
                <div class="form-row">
                    <div class="form-group">
                        <label>Finalidade *</label>
                        <select name="purpose" required>
                            <option value="">Selecione...</option>
                            <option th:each="p : ${addressPurposes}" th:value="${p}" th:text="${p}"></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Identificacao</label>
                        <input type="text" name="label" placeholder="Ex: Casa, Trabalho"/>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo de Residencia *</label>
                        <select name="residenceType" required>
                            <option value="">Selecione...</option>
                            <option th:each="r : ${residenceTypes}" th:value="${r}" th:text="${r}"></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Logradouro *</label>
                        <select name="streetType" required>
                            <option value="">Selecione...</option>
                            <option th:each="s : ${streetTypes}" th:value="${s}" th:text="${s}"></option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Logradouro *</label>
                        <input type="text" name="street" required placeholder="Nome da rua"/>
                    </div>
                    <div class="form-group">
                        <label>Numero *</label>
                        <input type="text" name="number" required placeholder="123"/>
                    </div>
                    <div class="form-group">
                        <label>Bairro *</label>
                        <input type="text" name="neighborhood" required placeholder="Nome do bairro"/>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>CEP *</label>
                        <input type="text" name="zipCode" required placeholder="00000-000"/>
                    </div>
                    <div class="form-group">
                        <label>Cidade *</label>
                        <input type="text" name="city" required placeholder="Nome da cidade"/>
                    </div>
                    <div class="form-group">
                        <label>Estado *</label>
                        <input type="text" name="state" required placeholder="UF"/>
                    </div>
                    <div class="form-group">
                        <label>Pais *</label>
                        <input type="text" name="country" required placeholder="Brasil"/>
                    </div>
                </div>
                <div class="form-group">
                    <label>Observacoes</label>
                    <textarea name="observations" placeholder="Informacoes adicionais (opcional)"></textarea>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Adicionar Endereco</button>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Cartoes de Credito</div>
        <div th:if="${customer.creditCards() != null and !customer.creditCards().isEmpty()}">
            <table>
                <thead><tr><th>Numero</th><th>Nome Impresso</th><th>Bandeira</th><th>Preferencial</th></tr></thead>
                <tbody>
                    <tr th:each="card : ${customer.creditCards()}">
                        <td th:text="${card.cardNumber()}"></td>
                        <td th:text="${card.printedName()}"></td>
                        <td th:text="${card.brand() != null ? card.brand().name() : ''}"></td>
                        <td>
                            <span th:if="${card.isPreferred()}" class="badge badge-active">Sim</span>
                            <span th:unless="${card.isPreferred()}" class="badge badge-inactive">Nao</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div th:if="${customer.creditCards() == null or customer.creditCards().isEmpty()}" class="empty-state">
            <p>Nenhum cartao de credito cadastrado.</p>
        </div>
        <div class="form-section" style="margin-top:1rem;">
            <div class="form-section-title">Adicionar Cartao de Credito</div>
            <form method="post" th:action="@{/customers/{id}/credit-cards(id=${customer.id()})}">
                <div class="form-row">
                    <div class="form-group">
                        <label>Numero do Cartao *</label>
                        <input type="text" name="cardNumber" required placeholder="0000 0000 0000 0000"/>
                    </div>
                    <div class="form-group">
                        <label>Nome Impresso *</label>
                        <input type="text" name="printedName" required placeholder="NOME COMO NO CARTAO"/>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ID da Bandeira *</label>
                        <input type="text" name="cardBrandId" required placeholder="ID da bandeira registrada"/>
                        <div class="form-hint">Deve ser uma bandeira registrada no sistema.</div>
                    </div>
                    <div class="form-group">
                        <label>Codigo de Seguranca *</label>
                        <input type="text" name="securityCode" required placeholder="123" maxlength="4"/>
                    </div>
                    <div class="form-group">
                        <label>Preferencial</label>
                        <select name="isPreferred">
                            <option value="false">Nao</option>
                            <option value="true">Sim</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary btn-sm">Adicionar Cartao</button>
            </form>
        </div>
    </div>

</div>
</html>
