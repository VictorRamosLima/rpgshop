<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: page('Detalhe do Pedido', ~{::main-content})}">
<div th:fragment="main-content">

    <nav class="breadcrumb-nav" aria-label="Breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Inicio</a></li>
            <li class="breadcrumb-item"><a href="/orders">Pedidos</a></li>
            <li class="breadcrumb-item" aria-current="page">Detalhe</li>
        </ol>
    </nav>

    <div class="page-header">
        <h1 class="page-title">Detalhe do Pedido</h1>
        <span class="badge" th:classappend="${order.status().name() == 'APPROVED' ? 'badge-active' : (order.status().name() == 'REJECTED' ? 'badge-inactive' : 'badge-warning')}" th:text="${order.status()}"></span>
    </div>

    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

    <div class="detail-grid">
        <div class="card">
            <div class="card-header">Informacoes do Pedido</div>
            <div class="form-row">
                <div class="info-group">
                    <div class="info-label">ID</div>
                    <div class="info-value" th:text="${order.id()}"></div>
                </div>
                <div class="info-group">
                    <div class="info-label">Cliente</div>
                    <div class="info-value" th:text="${order.customer() != null ? order.customer().name() : 'N/A'}"></div>
                </div>
            </div>
            <div class="form-row">
                <div class="info-group">
                    <div class="info-label">Data da Compra</div>
                    <div class="info-value" th:text="${order.purchasedAt()}"></div>
                </div>
                <div class="info-group">
                    <div class="info-label">Data de Despacho</div>
                    <div class="info-value" th:text="${order.dispatchedAt() != null ? order.dispatchedAt() : 'Pendente'}"></div>
                </div>
            </div>
            <div class="info-group">
                <div class="info-label">Data de Entrega</div>
                <div class="info-value" th:text="${order.deliveredAt() != null ? order.deliveredAt() : 'Pendente'}"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Valores</div>
            <div class="form-row">
                <div class="info-group">
                    <div class="info-label">Subtotal</div>
                    <div class="info-value" th:text="'R$ ' + ${#numbers.formatDecimal(order.subtotal(), 1, 2)}"></div>
                </div>
                <div class="info-group">
                    <div class="info-label">Frete (peso + fator regional)</div>
                    <div class="info-value" th:text="'R$ ' + ${#numbers.formatDecimal(order.freightCost(), 1, 2)}"></div>
                </div>
            </div>
            <div class="info-group">
                <div class="info-label">Total</div>
                <div class="info-value price" th:text="'R$ ' + ${#numbers.formatDecimal(order.total(), 1, 2)}"></div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Itens do Pedido</div>
        <div th:if="${order.items() != null and !order.items().isEmpty()}" class="table-wrap">
            <table>
            <thead>
                <tr><th>Produto</th><th>Quantidade</th><th>Preco Unitario</th><th>Total</th></tr>
            </thead>
            <tbody>
                <tr th:each="item : ${order.items()}">
                    <td th:text="${item.product() != null ? item.product().name() : 'N/A'}"></td>
                    <td th:text="${item.quantity()}"></td>
                    <td th:text="'R$ ' + ${#numbers.formatDecimal(item.unitPrice(), 1, 2)}"></td>
                    <td class="price" th:text="'R$ ' + ${#numbers.formatDecimal(item.totalPrice(), 1, 2)}"></td>
                </tr>
            </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Pagamentos</div>
        <div th:if="${order.payments() != null and !order.payments().isEmpty()}" class="table-wrap">
            <table>
            <thead>
                <tr><th>Cartao</th><th>Cupom</th><th>Valor</th></tr>
            </thead>
            <tbody>
                <tr th:each="payment : ${order.payments()}">
                    <td th:text="${payment.creditCard() != null ? payment.creditCard().cardNumber() : 'N/A'}"></td>
                    <td th:text="${payment.coupon() != null ? payment.coupon().code() : '-'}"></td>
                    <td class="price" th:text="'R$ ' + ${#numbers.formatDecimal(payment.amount(), 1, 2)}"></td>
                </tr>
            </tbody>
            </table>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Acoes do Pedido</div>
        <div class="btn-group">
            <form method="post" th:action="@{/orders/{id}/approve(id=${order.id()})}" th:if="${order.status().name() == 'PROCESSING'}" class="inline-actions">
                <button type="submit" class="btn btn-success">Processar Pagamento</button>
            </form>
            <form method="post" th:action="@{/orders/{id}/dispatch(id=${order.id()})}" th:if="${order.status().name() == 'APPROVED'}" class="inline-actions">
                <button type="submit" class="btn btn-primary">Despachar</button>
            </form>
            <form method="post" th:action="@{/orders/{id}/deliver(id=${order.id()})}" th:if="${order.status().name() == 'IN_TRANSIT'}" class="inline-actions">
                <button type="submit" class="btn btn-success">Confirmar Entrega</button>
            </form>
            <a th:href="@{/exchanges/new(orderId=${order.id()})}" class="btn btn-warning" th:if="${order.status().name() == 'DELIVERED'}">Solicitar Troca</a>
        </div>
    </div>
</div>
</html>
