<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments/layout :: page('Checkout', ~{::main-content})}">
<div th:fragment="main-content">
    <nav class="breadcrumb-nav" aria-label="Breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Inicio</a></li>
            <li class="breadcrumb-item"><a th:href="@{/cart/{id}(id=${customerId})}">Carrinho</a></li>
            <li class="breadcrumb-item" aria-current="page">Checkout</li>
        </ol>
    </nav>

    <header class="page-header">
        <div>
            <h1 class="page-title">Finalizar Compra</h1>
            <p class="page-subtitle">Escolha endereco, configure pagamentos combinados e conclua com pedido em processamento.</p>
        </div>
    </header>

    <div th:if="${error}" class="alert alert-error" th:text="${error}" role="alert"></div>

    <form method="post" action="/orders/checkout" id="checkoutForm">
        <input type="hidden" name="customerId" th:value="${customerId}"/>

        <section class="card">
            <div class="card-title">Endereco de Entrega</div>

            <div class="form-row">
                <label style="display:flex;gap:0.5rem;align-items:center;">
                    <input type="radio" name="addressMode" value="existing" checked />
                    Usar endereco existente
                </label>
                <label style="display:flex;gap:0.5rem;align-items:center;">
                    <input type="radio" name="addressMode" value="new" />
                    Cadastrar novo endereco
                </label>
            </div>

            <div id="existing-address-block" class="form-group">
                <label for="deliveryAddressId">Endereco existente</label>
                <select id="deliveryAddressId" name="deliveryAddressId">
                    <option value="">Selecione...</option>
                    <option th:each="address : ${deliveryAddresses}"
                            th:value="${address.id()}"
                            th:text="${(address.label() != null ? address.label() + ' - ' : '') + address.street() + ', ' + address.number() + ' - ' + address.city() + '/' + address.state()}">
                    </option>
                </select>
            </div>

            <div id="new-address-block" style="display:none;">
                <div class="form-row">
                    <div class="form-group">
                        <label for="newAddressLabel">Identificacao</label>
                        <input id="newAddressLabel" type="text" name="newAddressLabel" placeholder="Ex: Casa, Trabalho"/>
                    </div>
                    <div class="form-group">
                        <label for="newAddressResidenceType">Tipo de residencia (obrigatorio)</label>
                        <select id="newAddressResidenceType" name="newAddressResidenceType">
                            <option value="">Selecione...</option>
                            <option th:each="type : ${residenceTypes}" th:value="${type}" th:text="${type}"></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newAddressStreetType">Tipo de logradouro (obrigatorio)</label>
                        <select id="newAddressStreetType" name="newAddressStreetType">
                            <option value="">Selecione...</option>
                            <option th:each="type : ${streetTypes}" th:value="${type}" th:text="${type}"></option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="newAddressStreet">Logradouro (obrigatorio)</label>
                        <input id="newAddressStreet" type="text" name="newAddressStreet" />
                    </div>
                    <div class="form-group">
                        <label for="newAddressNumber">Numero (obrigatorio)</label>
                        <input id="newAddressNumber" type="text" name="newAddressNumber" />
                    </div>
                    <div class="form-group">
                        <label for="newAddressNeighborhood">Bairro (obrigatorio)</label>
                        <input id="newAddressNeighborhood" type="text" name="newAddressNeighborhood" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="newAddressZipCode">CEP (obrigatorio)</label>
                        <input id="newAddressZipCode" type="text" name="newAddressZipCode" />
                    </div>
                    <div class="form-group">
                        <label for="newAddressCity">Cidade (obrigatorio)</label>
                        <input id="newAddressCity" type="text" name="newAddressCity" />
                    </div>
                    <div class="form-group">
                        <label for="newAddressState">Estado (obrigatorio)</label>
                        <input id="newAddressState" type="text" name="newAddressState" />
                    </div>
                    <div class="form-group">
                        <label for="newAddressCountry">Pais (obrigatorio)</label>
                        <input id="newAddressCountry" type="text" name="newAddressCountry" value="Brasil" />
                    </div>
                </div>

                <div class="form-group">
                    <label for="newAddressObservations">Observacoes</label>
                    <textarea id="newAddressObservations" name="newAddressObservations" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label style="display:flex;gap:0.5rem;align-items:center;">
                        <input type="checkbox" name="saveNewAddressToProfile" value="true" checked />
                        Adicionar este endereco ao perfil do cliente
                    </label>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-title">Pagamentos</div>
            <p class="card-muted">Combine cartoes e cupons em varias linhas. Cupons sao priorizados automaticamente por maior valor.</p>

            <div id="payment-rows" style="display:flex;flex-direction:column;gap:1rem;">
                <div class="payment-row card" style="padding:1rem;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Cartao</label>
                            <select name="paymentCreditCardId">
                                <option value="">Sem cartao</option>
                                <option th:each="card : ${creditCards}"
                                        th:value="${card.id()}"
                                        th:text="${card.cardNumber() + (card.isPreferred() ? ' (Preferencial)' : '')}">
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cupom</label>
                            <select name="paymentCouponId">
                                <option value="">Sem cupom</option>
                                <option th:each="coupon : ${availableCoupons}"
                                        th:value="${coupon.id()}"
                                        th:text="${coupon.code() + ' - ' + coupon.type() + ' (R$ ' + #numbers.formatDecimal(coupon.value(), 1, 2) + ')'}">
                                </option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Valor (obrigatorio para cartao)</label>
                            <input type="number" step="0.01" min="0.01" name="paymentAmount" placeholder="0.00" />
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline btn-sm" data-remove-payment>Remover linha</button>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-outline" id="addPaymentRow">Adicionar forma de pagamento</button>
            </div>
        </section>

        <section class="card">
            <div class="card-title">Novo cartao no checkout (opcional)</div>
            <label style="display:flex;gap:0.5rem;align-items:center;">
                <input type="checkbox" name="useNewCard" value="true" id="useNewCard" />
                Cadastrar e usar novo cartao nesta compra
            </label>

            <div id="new-card-block" style="display:none;margin-top:1rem;">
                <div class="form-row">
                    <div class="form-group">
                        <label for="newCardNumber">Numero do cartao (obrigatorio)</label>
                        <input id="newCardNumber" type="text" name="newCardNumber" />
                    </div>
                    <div class="form-group">
                        <label for="newCardPrintedName">Nome impresso (obrigatorio)</label>
                        <input id="newCardPrintedName" type="text" name="newCardPrintedName" />
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="newCardBrandId">Bandeira (obrigatorio)</label>
                        <select id="newCardBrandId" name="newCardBrandId">
                            <option value="">Selecione...</option>
                            <option th:each="brand : ${cardBrands}" th:value="${brand.id()}" th:text="${brand.name()}"></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newCardSecurityCode">Codigo de seguranca (obrigatorio)</label>
                        <input id="newCardSecurityCode" type="text" name="newCardSecurityCode" maxlength="4" />
                    </div>
                    <div class="form-group">
                        <label style="display:flex;gap:0.5rem;align-items:center;margin-top:2rem;">
                            <input type="checkbox" name="newCardPreferred" value="true" />
                            Definir como preferencial
                        </label>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="newCardCouponId">Cupom para novo cartao</label>
                        <select id="newCardCouponId" name="newCardCouponId">
                            <option value="">Sem cupom</option>
                            <option th:each="coupon : ${availableCoupons}"
                                    th:value="${coupon.id()}"
                                    th:text="${coupon.code() + ' - ' + coupon.type() + ' (R$ ' + #numbers.formatDecimal(coupon.value(), 1, 2) + ')'}">
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newCardAmount">Valor do novo cartao (obrigatorio)</label>
                        <input id="newCardAmount" type="number" step="0.01" min="0.01" name="newCardAmount" placeholder="0.00" />
                    </div>
                </div>
            </div>
        </section>

        <section class="card">
            <div class="card-title">Frete</div>
            <p class="card-muted">O frete sera calculado considerando peso dos itens e regiao do endereco informado.</p>
        </section>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">Confirmar Pedido</button>
            <a th:href="@{/cart/{id}(id=${customerId})}" class="btn btn-outline btn-lg">Voltar ao Carrinho</a>
        </div>
    </form>

    <script>
        (function () {
            const addressModeInputs = document.querySelectorAll('input[name="addressMode"]');
            const existingAddressBlock = document.getElementById('existing-address-block');
            const newAddressBlock = document.getElementById('new-address-block');

            function toggleAddressBlock() {
                const selected = document.querySelector('input[name="addressMode"]:checked');
                const isNew = selected && selected.value === 'new';
                existingAddressBlock.style.display = isNew ? 'none' : 'block';
                newAddressBlock.style.display = isNew ? 'block' : 'none';
            }

            addressModeInputs.forEach(function (input) {
                input.addEventListener('change', toggleAddressBlock);
            });
            toggleAddressBlock();

            const useNewCardCheckbox = document.getElementById('useNewCard');
            const newCardBlock = document.getElementById('new-card-block');
            function toggleNewCardBlock() {
                newCardBlock.style.display = useNewCardCheckbox.checked ? 'block' : 'none';
            }
            useNewCardCheckbox.addEventListener('change', toggleNewCardBlock);
            toggleNewCardBlock();

            const paymentRows = document.getElementById('payment-rows');
            const addPaymentRow = document.getElementById('addPaymentRow');

            function bindRemoveButton(button) {
                button.addEventListener('click', function () {
                    const rows = paymentRows.querySelectorAll('.payment-row');
                    if (rows.length <= 1) {
                        return;
                    }
                    const row = button.closest('.payment-row');
                    if (row) {
                        row.remove();
                    }
                });
            }

            paymentRows.querySelectorAll('[data-remove-payment]').forEach(bindRemoveButton);

            addPaymentRow.addEventListener('click', function () {
                const firstRow = paymentRows.querySelector('.payment-row');
                if (!firstRow) {
                    return;
                }
                const clone = firstRow.cloneNode(true);
                clone.querySelectorAll('input').forEach(function (input) {
                    input.value = '';
                });
                clone.querySelectorAll('select').forEach(function (select) {
                    select.value = '';
                });

                const removeButton = clone.querySelector('[data-remove-payment]');
                if (removeButton) {
                    bindRemoveButton(removeButton);
                }

                paymentRows.appendChild(clone);
            });
        })();
    </script>
</div>
</html>
