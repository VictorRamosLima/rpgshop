<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: page('Carrinho', ~{::main-content})}">
<div th:fragment="main-content">

    <div class="breadcrumb">
        <a href="/">Inicio</a> <span>/</span> <a href="/customers">Clientes</a> <span>/</span> <span>Carrinho</span>
    </div>

    <div class="page-header">
        <h1>&#128722; Carrinho de Compras</h1>
        <div class="btn-group">
            <a th:href="@{/orders/checkout/{id}(id=${customerId})}" class="btn btn-primary btn-lg" th:if="${cart != null and cart.items() != null and !cart.items().isEmpty()}">Finalizar Pedido</a>
        </div>
    </div>

    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

    <div th:if="${cart != null and cart.items() != null and !cart.items().isEmpty()}">
        <table>
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Preco Unitario</th>
                    <th>Quantidade</th>
                    <th>Subtotal</th>
                    <th>Status</th>
                    <th>Acoes</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="item : ${cart.items()}">
                    <td>
                        <a th:href="@{/products/{id}(id=${item.product().id()})}" th:text="${item.product().name()}"></a>
                    </td>
                    <td>
                        <span class="price" th:text="'R$ ' + ${#numbers.formatDecimal(item.product().salePrice(), 1, 2)}"></span>
                    </td>
                    <td>
                        <form method="post" th:action="@{/cart/{cid}/update(cid=${customerId})}" style="display:inline-flex;gap:0.5rem;align-items:center;">
                            <input type="hidden" name="productId" th:value="${item.product().id()}"/>
                            <input type="number" name="quantity" th:value="${item.quantity()}" min="1" style="width:80px;"/>
                            <button type="submit" class="btn btn-sm btn-outline">Atualizar</button>
                        </form>
                    </td>
                    <td>
                        <span class="price" th:text="'R$ ' + ${#numbers.formatDecimal(item.product().salePrice() * item.quantity(), 1, 2)}"></span>
                    </td>
                    <td>
                        <span th:if="${item.isBlocked()}" class="badge badge-warning">Bloqueado</span>
                        <span th:unless="${item.isBlocked()}" class="badge badge-active">Disponivel</span>
                    </td>
                    <td>
                        <form method="post" th:action="@{/cart/{cid}/remove(cid=${customerId})}" style="display:inline;">
                            <input type="hidden" name="productId" th:value="${item.product().id()}"/>
                            <button type="submit" class="btn btn-sm btn-danger">Remover</button>
                        </form>
                    </td>
                </tr>
            </tbody>
        </table>

        <div style="margin-top:1rem;display:flex;gap:1rem;justify-content:space-between;align-items:center;">
            <form method="post" th:action="@{/cart/{cid}/clear(cid=${customerId})}">
                <button type="submit" class="btn btn-danger">Limpar Carrinho</button>
            </form>
            <a th:href="@{/orders/checkout/{id}(id=${customerId})}" class="btn btn-primary btn-lg">Finalizar Pedido</a>
        </div>
    </div>

    <div th:if="${cart == null or cart.items() == null or cart.items().isEmpty()}" class="empty-state">
        <div class="empty-state-icon">&#128722;</div>
        <div class="empty-state-text">Seu carrinho esta vazio</div>
        <p><a href="/products">Explorar produtos</a></p>
    </div>

    <div class="card" style="margin-top:2rem;">
        <div class="card-header">Adicionar Produto ao Carrinho</div>
        <form method="post" th:action="@{/cart/{cid}/add(cid=${customerId})}">
            <div class="form-row">
                <div class="form-group">
                    <label>ID do Produto *</label>
                    <input type="text" name="productId" required placeholder="UUID do produto"/>
                </div>
                <div class="form-group">
                    <label>Quantidade *</label>
                    <input type="number" name="quantity" required min="1" value="1"/>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Adicionar ao Carrinho</button>
        </form>
    </div>

</div>
</html>
