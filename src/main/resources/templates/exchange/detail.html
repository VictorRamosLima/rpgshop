<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: page('Detalhe da Troca', ~{::main-content})}">
<div th:fragment="main-content">

    <div class="breadcrumb">
        <a href="/">Inicio</a> <span>/</span> <a href="/exchanges">Trocas</a> <span>/</span> <span>Detalhe</span>
    </div>

    <div class="page-header">
        <h1>Detalhes da Solicitacao de Troca</h1>
        <span class="badge" th:classappend="${exchange.status().name() == 'AUTHORIZED' ? 'badge-active' : (exchange.status().name() == 'DENIED' ? 'badge-inactive' : 'badge-warning')}" th:text="${exchange.status()}"></span>
    </div>

    <div th:if="${error}" class="alert alert-error" th:text="${error}"></div>

    <div class="detail-grid">
        <div class="card">
            <div class="card-header">Informacoes da Troca</div>
            <div class="form-row">
                <div class="info-group">
                    <div class="info-label">ID da Troca</div>
                    <div class="info-value" th:text="${exchange.id()}"></div>
                </div>
                <div class="info-group">
                    <div class="info-label">Pedido</div>
                    <div class="info-value">
                        <a th:href="@{/orders/{id}(id=${exchange.order().id()})}" th:text="${exchange.order().id()}"></a>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="info-group">
                    <div class="info-label">Produto</div>
                    <div class="info-value" th:text="${exchange.orderItem() != null and exchange.orderItem().product() != null ? exchange.orderItem().product().name() : 'N/A'}"></div>
                </div>
                <div class="info-group">
                    <div class="info-label">Quantidade</div>
                    <div class="info-value" th:text="${exchange.quantity()}"></div>
                </div>
            </div>
            <div class="info-group">
                <div class="info-label">Motivo</div>
                <div class="info-value" th:text="${exchange.reason()}"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Datas e Cupom</div>
            <div class="info-group">
                <div class="info-label">Solicitado em</div>
                <div class="info-value" th:text="${exchange.createdAt()}"></div>
            </div>
            <div class="info-group">
                <div class="info-label">Autorizado em</div>
                <div class="info-value" th:text="${exchange.authorizedAt() != null ? exchange.authorizedAt() : 'Pendente'}"></div>
            </div>
            <div class="info-group">
                <div class="info-label">Recebido em</div>
                <div class="info-value" th:text="${exchange.receivedAt() != null ? exchange.receivedAt() : 'Pendente'}"></div>
            </div>
            <div class="info-group" th:if="${exchange.coupon() != null}">
                <div class="info-label">Cupom de troca gerado</div>
                <div class="info-value" th:text="${exchange.coupon().code() + ' - R$ ' + #numbers.formatDecimal(exchange.coupon().value(), 1, 2)}"></div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Acoes</div>
        <div class="btn-group">
            <form method="post" th:action="@{/exchanges/{id}/authorize(id=${exchange.id()})}" th:if="${exchange.status().name() == 'REQUESTED'}" style="display:inline;">
                <button type="submit" class="btn btn-success">Autorizar Troca</button>
            </form>
            <form method="post" th:action="@{/exchanges/{id}/deny(id=${exchange.id()})}" th:if="${exchange.status().name() == 'REQUESTED'}" style="display:inline;">
                <button type="submit" class="btn btn-danger">Negar Troca</button>
            </form>
        </div>

        <form method="post" th:action="@{/exchanges/{id}/receive(id=${exchange.id()})}" th:if="${exchange.status().name() == 'AUTHORIZED'}" style="margin-top:1rem;">
            <div class="form-group">
                <label style="display:flex;gap:0.5rem;align-items:center;">
                    <input type="checkbox" name="returnToStock" value="true" id="returnToStock" />
                    Devolver item ao estoque
                </label>
            </div>

            <div id="reentry-fields" style="display:none;">
                <div class="form-row">
                    <div class="form-group">
                        <label for="supplierId">Fornecedor da reentrada (obrigatorio quando marcado)</label>
                        <select id="supplierId" name="supplierId">
                            <option value="">Selecione...</option>
                            <option th:each="supplier : ${activeSuppliers}" th:value="${supplier.id()}" th:text="${supplier.name()}"></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="costValue">Valor de custo da reentrada (obrigatorio quando marcado)</label>
                        <input id="costValue" type="number" step="0.01" min="0.01" name="costValue" placeholder="0.00" />
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary">Confirmar Recebimento</button>
        </form>
    </div>

    <script>
        (function () {
            const checkbox = document.getElementById('returnToStock');
            const reentryFields = document.getElementById('reentry-fields');

            if (!checkbox || !reentryFields) {
                return;
            }

            function toggleFields() {
                reentryFields.style.display = checkbox.checked ? 'block' : 'none';
            }

            checkbox.addEventListener('change', toggleFields);
            toggleFields();
        })();
    </script>

</div>
</html>
